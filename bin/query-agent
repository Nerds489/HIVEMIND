#!/bin/bash
# Query an agent's workspace for results

set -euo pipefail

HIVEMIND_ROOT="${HIVEMIND_ROOT:-$(dirname "$(dirname "$(realpath "$0")")")}"

AGENT_TYPE="${1:-}"
TASK_ID="${2:-}"

if [[ -z "$AGENT_TYPE" ]]; then
    echo "Usage: query-agent <agent-type> [task-id]" >&2
    echo "" >&2
    echo "Available agent workspaces:" >&2
    ls -la "$HIVEMIND_ROOT/workspace/" 2>/dev/null >&2 || echo "  (none)" >&2
    exit 1
fi

WORKSPACE="$HIVEMIND_ROOT/workspace/$AGENT_TYPE"

if [[ -n "$TASK_ID" ]]; then
    WORKSPACE="$WORKSPACE/$TASK_ID"
fi

if [[ ! -d "$WORKSPACE" ]]; then
    echo "Workspace not found: $WORKSPACE" >&2
    exit 1
fi

if [[ -z "$TASK_ID" ]]; then
    LATEST="$(ls -t "$WORKSPACE" 2>/dev/null | head -1 || true)"
    if [[ -n "$LATEST" ]]; then
        WORKSPACE="$WORKSPACE/$LATEST"
        echo "Latest task: $LATEST"
    fi
fi

echo "═══════════════════════════════════════"
echo "Workspace: $WORKSPACE"
echo "═══════════════════════════════════════"

if [[ -f "$WORKSPACE/status.txt" ]]; then
    echo "Status: $(cat "$WORKSPACE/status.txt")"
fi

if [[ -f "$WORKSPACE/result.md" ]]; then
    echo ""
    echo "Result:"
    cat "$WORKSPACE/result.md"
fi

if [[ -d "$WORKSPACE/code" ]]; then
    echo ""
    echo "Code files:"
    ls -la "$WORKSPACE/code/"
fi
