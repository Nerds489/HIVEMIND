#!/bin/bash
#
# Spawn a sub-agent using configured engine
#
# Usage:
#   spawn-agent <agent-type> "<task>"
#   spawn-agent <agent-id> "<task>"

set -euo pipefail

HIVEMIND_ROOT="${HIVEMIND_ROOT:-$(dirname "$(dirname "$(realpath "$0")")")}"
source "$HIVEMIND_ROOT/engines/engine.sh"

INPUT_AGENT="${1:-}"
TASK="${2:-}"
TASK_ID="$(date +%s)_$$"

AGENT_ENGINE="${AGENT_ENGINE:-$(load_engine_config "agents")}"

if [[ -z "$INPUT_AGENT" ]] || [[ -z "$TASK" ]]; then
    echo "Usage: spawn-agent <agent-type|agent-id> \"<task>\"" >&2
    "$HIVEMIND_ROOT/bin/list-agents" >&2 || true
    exit 1
fi

map_agent_id_to_type() {
    local id="$1"
    case "$id" in
        DEV-001) echo "architect" ;;
        DEV-002) echo "backend" ;;
        DEV-003) echo "frontend" ;;
        DEV-004) echo "reviewer" ;;
        DEV-005) echo "writer" ;;
        DEV-006) echo "devops" ;;
        SEC-001) echo "security-architect" ;;
        SEC-002) echo "pentester" ;;
        SEC-003) echo "malware" ;;
        SEC-004) echo "wireless" ;;
        SEC-005) echo "compliance" ;;
        SEC-006) echo "incident" ;;
        INF-001) echo "infra-architect" ;;
        INF-002) echo "sysadmin" ;;
        INF-003) echo "network" ;;
        INF-004) echo "dba" ;;
        INF-005) echo "sre" ;;
        INF-006) echo "automation" ;;
        QA-001) echo "qa-architect" ;;
        QA-002) echo "test-auto" ;;
        QA-003) echo "performance" ;;
        QA-004) echo "security-test" ;;
        QA-005) echo "manual-qa" ;;
        QA-006) echo "test-data" ;;
        *) echo "" ;;
    esac
}

AGENT_TYPE="$INPUT_AGENT"
if [[ "$INPUT_AGENT" =~ ^[A-Z]{2,4}-[0-9]{3}$ ]]; then
    mapped="$(map_agent_id_to_type "$INPUT_AGENT")"
    if [[ -z "$mapped" ]]; then
        echo "Unknown agent id: $INPUT_AGENT" >&2
        exit 1
    fi
    AGENT_TYPE="$mapped"
fi

get_agent_prompt_file() {
    local type="$1"
    case "$type" in
        architect)          echo "dev/architect.md" ;;
        backend)            echo "dev/backend.md" ;;
        frontend)           echo "dev/frontend.md" ;;
        reviewer)           echo "dev/reviewer.md" ;;
        writer)             echo "dev/writer.md" ;;
        devops)             echo "dev/devops.md" ;;
        security-architect) echo "security/architect.md" ;;
        pentester)          echo "security/pentester.md" ;;
        malware)            echo "security/malware.md" ;;
        wireless)           echo "security/wireless.md" ;;
        compliance)         echo "security/compliance.md" ;;
        incident)           echo "security/incident.md" ;;
        infra-architect)    echo "infrastructure/architect.md" ;;
        sysadmin)           echo "infrastructure/sysadmin.md" ;;
        network)            echo "infrastructure/network.md" ;;
        dba)                echo "infrastructure/dba.md" ;;
        sre)                echo "infrastructure/sre.md" ;;
        automation)         echo "infrastructure/automation.md" ;;
        qa-architect)       echo "qa/architect.md" ;;
        test-auto)          echo "qa/automation.md" ;;
        performance)        echo "qa/performance.md" ;;
        security-test)      echo "qa/security.md" ;;
        manual-qa)          echo "qa/manual.md" ;;
        test-data)          echo "qa/data.md" ;;
        *)
            echo ""
            ;;
    esac
}

PROMPT_FILE="$(get_agent_prompt_file "$AGENT_TYPE")"
if [[ -z "$PROMPT_FILE" ]]; then
    echo "Unknown agent type: $AGENT_TYPE" >&2
    "$HIVEMIND_ROOT/bin/list-agents" >&2 || true
    exit 1
fi

FULL_PROMPT_PATH="$HIVEMIND_ROOT/agents/$PROMPT_FILE"
if [[ ! -f "$FULL_PROMPT_PATH" ]]; then
    echo "Agent prompt not found: $FULL_PROMPT_PATH" >&2
    exit 1
fi

WORKSPACE="$HIVEMIND_ROOT/workspace/$AGENT_TYPE/$TASK_ID"
mkdir -p "$WORKSPACE/code" "$WORKSPACE/artifacts"

FULL_PROMPT=$(cat << EOF
$(cat "$HIVEMIND_ROOT/agents/base-prompt.md")

---

$(cat "$FULL_PROMPT_PATH")

---

TASK: $TASK

OUTPUT RULES:
- Output MUST be valid Markdown.
- Do NOT mention internal agent IDs, routing, spawning, or orchestration.
- Speak in first person singular (“I …”).
- Provide a complete, actionable result for the task.

Execute now.
EOF
)

touch "$WORKSPACE/status.txt"
echo "RUNNING" > "$WORKSPACE/status.txt"
echo "$AGENT_ENGINE" > "$WORKSPACE/engine.txt"

(
    set -euo pipefail
    trap 'echo "ERROR" > "$WORKSPACE/status.txt"' ERR

    # Capture the model output as the agent result (so orchestration works end-to-end).
    run_engine "$AGENT_ENGINE" "$FULL_PROMPT" "Execute the assigned task" "print" \
      2> "$WORKSPACE/stderr.log" \
      | tee "$WORKSPACE/result.md" > "$WORKSPACE/stdout.log"

    echo "DONE" > "$WORKSPACE/status.txt"
) &

AGENT_PID=$!
echo "$AGENT_PID" > "$WORKSPACE/pid.txt"

cat << EOF
{
  "agent": "$AGENT_TYPE",
  "task_id": "$TASK_ID",
  "pid": $AGENT_PID,
  "engine": "$AGENT_ENGINE",
  "workspace": "$WORKSPACE",
  "status": "spawned"
}
EOF
