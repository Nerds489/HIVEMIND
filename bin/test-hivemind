#!/bin/bash
# Test/validate the HIVEMIND installation and repository integrity.

set -euo pipefail

HIVEMIND_ROOT="${HIVEMIND_ROOT:-$(dirname "$(dirname "$(realpath "$0")")")}"

pass() { echo "PASS${1:+ ($1)}"; }
fail() { echo "FAIL${1:+ ($1)}"; }
warn() { echo "WARN${1:+ ($1)}"; }

echo "HIVEMIND System Test"
echo "===================="

echo -n "1. File count (>=250): "
file_count="$(find "$HIVEMIND_ROOT" -type f | wc -l | tr -d ' ')"
if [[ "$file_count" -ge 250 ]]; then pass "$file_count"; else fail "$file_count"; fi

echo -n "2. Config loads: "
"$HIVEMIND_ROOT/hivemind" --config >/dev/null 2>&1 && pass || fail

echo -n "3. Help works: "
"$HIVEMIND_ROOT/hivemind" --help >/dev/null 2>&1 && pass || fail

echo -n "4. CLI scripts executable: "
bin_bad=0
for f in "$HIVEMIND_ROOT/bin"/*; do
  [[ -f "$f" ]] || continue
  [[ -x "$f" ]] || bin_bad=$((bin_bad + 1))
  head -n 1 "$f" | grep -q "^#!" || bin_bad=$((bin_bad + 1))
  grep -q "set -euo pipefail" "$f" || bin_bad=$((bin_bad + 1))
done
if [[ "$bin_bad" -eq 0 ]]; then pass; else fail "$bin_bad"; fi

echo -n "5. Engine abstraction: "
source "$HIVEMIND_ROOT/engines/engine.sh"
[[ "$(get_engine_command codex)" == "codex" ]] && pass || fail

echo -n "6. Memory store: "
id=$("$HIVEMIND_ROOT/bin/memory-ops" store fact "Test memory" test)
[[ "$id" =~ ^mem_[a-z0-9]{12}$ ]] && pass "$id" || fail "$id"

echo -n "7. Memory recall: "
result=$("$HIVEMIND_ROOT/bin/memory-ops" recall "Test" || true)
[[ -n "$result" ]] && pass || fail

echo -n "8. CLAUDE.md (>=500 lines): "
claude_lines="$(wc -l < "$HIVEMIND_ROOT/CLAUDE.md" | tr -d ' ')"
if [[ "$claude_lines" -ge 500 ]]; then pass "$claude_lines"; else fail "$claude_lines"; fi

echo -n "9. COORDINATOR.md (>=500 lines): "
coord_lines="$(wc -l < "$HIVEMIND_ROOT/orchestration/COORDINATOR.md" | tr -d ' ')"
if [[ "$coord_lines" -ge 500 ]]; then pass "$coord_lines"; else fail "$coord_lines"; fi

echo -n "10. 24 role docs (500-800 lines): "
role_docs=(
  "$HIVEMIND_ROOT/agents/development/architect.md"
  "$HIVEMIND_ROOT/agents/development/backend-developer.md"
  "$HIVEMIND_ROOT/agents/development/frontend-developer.md"
  "$HIVEMIND_ROOT/agents/development/code-reviewer.md"
  "$HIVEMIND_ROOT/agents/development/technical-writer.md"
  "$HIVEMIND_ROOT/agents/development/devops-liaison.md"
  "$HIVEMIND_ROOT/agents/security/security-architect.md"
  "$HIVEMIND_ROOT/agents/security/penetration-tester.md"
  "$HIVEMIND_ROOT/agents/security/malware-analyst.md"
  "$HIVEMIND_ROOT/agents/security/wireless-security-expert.md"
  "$HIVEMIND_ROOT/agents/security/compliance-auditor.md"
  "$HIVEMIND_ROOT/agents/security/incident-responder.md"
  "$HIVEMIND_ROOT/agents/infrastructure/infrastructure-architect.md"
  "$HIVEMIND_ROOT/agents/infrastructure/systems-administrator.md"
  "$HIVEMIND_ROOT/agents/infrastructure/network-engineer.md"
  "$HIVEMIND_ROOT/agents/infrastructure/database-administrator.md"
  "$HIVEMIND_ROOT/agents/infrastructure/site-reliability-engineer.md"
  "$HIVEMIND_ROOT/agents/infrastructure/automation-engineer.md"
  "$HIVEMIND_ROOT/agents/qa/qa-architect.md"
  "$HIVEMIND_ROOT/agents/qa/test-automation-engineer.md"
  "$HIVEMIND_ROOT/agents/qa/performance-tester.md"
  "$HIVEMIND_ROOT/agents/qa/security-tester.md"
  "$HIVEMIND_ROOT/agents/qa/manual-qa-tester.md"
  "$HIVEMIND_ROOT/agents/qa/test-data-manager.md"
)

bad=0
for f in "${role_docs[@]}"; do
  [[ -f "$f" ]] || { bad=$((bad + 1)); continue; }
  n="$(wc -l < "$f" | tr -d ' ')"
  if [[ "$n" -lt 500 || "$n" -gt 800 ]]; then
    bad=$((bad + 1))
  fi
done
if [[ "$bad" -eq 0 ]]; then pass "24 files"; else fail "$bad"; fi

echo -n "11. Workflows (>=200 lines each): "
wf_bad=0
for f in "$HIVEMIND_ROOT/workflows"/*.md; do
  n="$(wc -l < "$f" | tr -d ' ')"
  [[ "$n" -ge 200 ]] || wf_bad=$((wf_bad + 1))
done
if [[ "$wf_bad" -eq 0 ]]; then pass; else fail "$wf_bad"; fi

echo -n "12. Memory IDs strict (mem_[a-z0-9]{12}): "
bad_ids="$(HIVEMIND_ROOT="$HIVEMIND_ROOT" python - <<'PY'
import json, os, pathlib, re
root=pathlib.Path(os.environ['HIVEMIND_ROOT'])/'memory'
pat=re.compile(r'^mem_[a-z0-9]{12}$')
bad=[0]
for p in root.rglob('*.json'):
    try:
        data=json.loads(p.read_text(encoding='utf-8', errors='ignore'))
    except Exception:
        continue
    def walk(obj):
        if isinstance(obj, dict):
            v=obj.get('id')
            if isinstance(v,str) and v.startswith('mem_') and not pat.match(v):
                bad[0] += 1
            for vv in obj.values():
                walk(vv)
        elif isinstance(obj, list):
            for vv in obj:
                walk(vv)
    walk(data)
print(bad[0])
PY
)"
if [[ "$bad_ids" == "0" ]]; then pass; else fail "$bad_ids"; fi

echo -n "13. Engines available (codex/claude): "
eng=0
command -v codex >/dev/null 2>&1 && eng=$((eng + 1))
command -v claude >/dev/null 2>&1 && eng=$((eng + 1))
if [[ "$eng" -ge 1 ]]; then pass; else warn "no engines detected"; fi

echo ""
echo "Tests complete."
