#!/bin/bash
# Orchestrate multiple agents and synthesize results

set -euo pipefail

HIVEMIND_ROOT="${HIVEMIND_ROOT:-$(dirname "$(dirname "$(realpath "$0")")")}"
source "$HIVEMIND_ROOT/engines/engine.sh"

TIMEOUT_SECONDS="${HIVEMIND_TIMEOUT_SECONDS:-300}"
VERBOSE=0

print_usage() {
  cat <<'EOF' >&2
Usage:
  orchestrate [--timeout <seconds>] [--verbose] "<task>" agent1 agent2 ...
EOF
}

log() {
  if [[ "${VERBOSE}" -eq 1 ]]; then
    echo "$@" >&2
  fi
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --timeout)
      TIMEOUT_SECONDS="${2:-}"
      shift 2
      ;;
    --verbose)
      VERBOSE=1
      shift
      ;;
    -h|--help)
      print_usage
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

TASK="${1:-}"
shift || true
AGENTS=("$@")

if [[ -z "$TASK" ]] || [[ ${#AGENTS[@]} -eq 0 ]]; then
  print_usage
  exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
  echo "Error: jq is required for orchestrate." >&2
  exit 1
fi

TASK_ID="$(date +%s)_$$"
ORCHESTRATION_DIR="$HIVEMIND_ROOT/workspace/_orchestrations/$TASK_ID"
mkdir -p "$ORCHESTRATION_DIR"

declare -A WORKSPACES

for agent in "${AGENTS[@]}"; do
  result="$("$HIVEMIND_ROOT/bin/spawn-agent" "$agent" "$TASK")"
  workspace="$(echo "$result" | jq -r '.workspace')"
  WORKSPACES["$agent"]="$workspace"
  log "Spawned -> $workspace"
done

log "Waiting for agents to complete..."

RESULTS_LABELED=""
RESULTS_ANON=""
idx=0

for agent in "${AGENTS[@]}"; do
  idx=$((idx + 1))
  workspace="${WORKSPACES[$agent]}"
  log "Waiting -> $workspace"
  result="$("$HIVEMIND_ROOT/bin/wait-agent" "$workspace" "$TIMEOUT_SECONDS")"
  RESULTS_LABELED="${RESULTS_LABELED}\n\n## ${agent}\n${result}"
  RESULTS_ANON="${RESULTS_ANON}\n\n## Specialist ${idx}\n${result}"
done

echo -e "$RESULTS_LABELED" > "$ORCHESTRATION_DIR/combined.md"

SYNTHESIS_PROMPT="You are synthesizing outputs from multiple specialists into ONE unified response.

Task: $TASK

Specialist Outputs:
$RESULTS_ANON

Synthesize these into a single, coherent response. Use first person singular (“I …”). Do not reference the specialists, agents, routing, orchestration, or any internal steps."

SYN_ENGINE="${HIVEMIND_ENGINE:-$(load_engine_config "hivemind")}"

if ! command -v "$(get_engine_command "$SYN_ENGINE")" >/dev/null 2>&1; then
  echo "Error: synthesis engine '$SYN_ENGINE' not available. See: $ORCHESTRATION_DIR/combined.md" >&2
  exit 1
fi

run_engine "$SYN_ENGINE" "$SYNTHESIS_PROMPT" "Synthesize into one unified response" "print" > "$ORCHESTRATION_DIR/synthesis.md"
cat "$ORCHESTRATION_DIR/synthesis.md"

