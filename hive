#!/usr/bin/env bash
# ============================================================
# HIVE - Interactive Multi-Agent Menu
# Codex (main) + Claude (sub-agents)
# ============================================================

set -euo pipefail

HIVEMIND_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="2.0.0"

# Colors
MAG=$'\033[38;5;201m'
CYN=$'\033[38;5;51m'
GRN=$'\033[1;32m'
YLW=$'\033[1;33m'
RED=$'\033[1;31m'
WHT=$'\033[1;97m'
DIM=$'\033[2m'
RST=$'\033[0m'

# Engine config
MAIN_ENGINE="codex"
SUB_ENGINE="claude"

# Check dependencies
check_deps() {
    local missing=()
    command -v gum >/dev/null 2>&1 || missing+=("gum")
    command -v codex >/dev/null 2>&1 || missing+=("codex")
    command -v claude >/dev/null 2>&1 || missing+=("claude")

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "${RED}Missing dependencies: ${missing[*]}${RST}"
        echo "Install with:"
        for dep in "${missing[@]}"; do
            case "$dep" in
                gum) echo "  brew install gum  OR  go install github.com/charmbracelet/gum@latest" ;;
                codex) echo "  pip install openai-codex" ;;
                claude) echo "  npm install -g @anthropic-ai/claude-code" ;;
            esac
        done
        exit 1
    fi
}

# Banner
show_banner() {
    clear
    gum style \
        --border double \
        --border-foreground 201 \
        --padding "1 4" \
        --margin "1" \
        --align center \
        "$(echo -e "${MAG}‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó${CYN}‚ñà‚ñà‚ïó${MAG}‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó${CYN}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${MAG}‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó${CYN}‚ñà‚ñà‚ïó${MAG}‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó${CYN}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${RST}
${MAG}‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù${MAG}‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó${RST}
${MAG}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ${MAG}‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë${RST}
${MAG}‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù${CYN}‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ${MAG}‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë${RST}
${MAG}‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG} ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ${CYN}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${MAG}‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ïë${MAG}‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë${CYN}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù${RST}
${MAG}‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù${CYN}‚ïö‚ïê‚ïù${MAG}  ‚ïö‚ïê‚ïê‚ïê‚ïù  ${CYN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${MAG}‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù${CYN}‚ïö‚ïê‚ïù${MAG}‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù${CYN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RST}

${DIM}24 Agents ‚Ä¢ 4 Teams ‚Ä¢ 1 Unified Intelligence${RST}
${DIM}Main: ${GRN}Codex${RST} ${DIM}| Sub-Agents: ${CYN}Claude${RST}")"
}

# Main menu
main_menu() {
    local choice
    choice=$(gum choose \
        --cursor.foreground 201 \
        --selected.foreground 51 \
        --header "$(echo -e "${WHT}HIVEMIND COMMAND CENTER${RST}")" \
        "üöÄ Execute Task" \
        "ü§ñ Agent Teams" \
        "üîß Orchestrate Multi-Agent" \
        "üíæ Memory Operations" \
        "üìä System Status" \
        "‚öôÔ∏è  Configuration" \
        "‚ùå Exit")

    case "$choice" in
        "üöÄ Execute Task") execute_task ;;
        "ü§ñ Agent Teams") agent_teams_menu ;;
        "üîß Orchestrate Multi-Agent") orchestrate_menu ;;
        "üíæ Memory Operations") memory_menu ;;
        "üìä System Status") show_status ;;
        "‚öôÔ∏è  Configuration") config_menu ;;
        "‚ùå Exit") exit 0 ;;
    esac
}

# Execute a task with Codex (main engine)
execute_task() {
    show_banner
    local task
    task=$(gum input \
        --placeholder "Enter your task..." \
        --prompt "TASK> " \
        --prompt.foreground 201 \
        --width 80)

    if [[ -z "$task" ]]; then
        return
    fi

    gum spin --spinner dot --title "Processing with Codex..." -- sleep 0.5

    echo ""
    gum style --border rounded --border-foreground 51 --padding "1" --margin "1" "$(echo -e "${CYN}EXECUTING:${RST} $task")"
    echo ""

    # Execute with Codex
    codex --full-auto --quiet "$task" 2>&1 | gum pager

    gum confirm "Return to menu?" && return || exit 0
}

# Agent teams menu
agent_teams_menu() {
    show_banner
    local team
    team=$(gum choose \
        --cursor.foreground 201 \
        --header "$(echo -e "${WHT}SELECT TEAM${RST}")" \
        "üî∑ DEV - Development Team" \
        "üî¥ SEC - Security Team" \
        "üü¢ INF - Infrastructure Team" \
        "üü° QA - Quality Assurance Team" \
        "‚¨ÖÔ∏è  Back")

    case "$team" in
        *DEV*) show_team_agents "DEV" "Architect|Backend|Frontend|Reviewer|Writer|DevOps" ;;
        *SEC*) show_team_agents "SEC" "Security Arch|Pentester|Malware|Wireless|Compliance|Incident" ;;
        *INF*) show_team_agents "INF" "Infra Arch|SysAdmin|Network|DBA|SRE|Automation" ;;
        *QA*) show_team_agents "QA" "QA Arch|Test Auto|Perf Test|Sec Test|Manual QA|Test Data" ;;
        *Back*) return ;;
    esac
}

# Show agents in a team
show_team_agents() {
    local team="$1"
    local agents_str="$2"
    IFS='|' read -ra agents <<< "$agents_str"

    show_banner

    local options=()
    for agent in "${agents[@]}"; do
        options+=("$agent")
    done
    options+=("‚¨ÖÔ∏è  Back")

    local agent
    agent=$(gum choose \
        --cursor.foreground 201 \
        --header "$(echo -e "${WHT}${team} TEAM AGENTS${RST}")" \
        "${options[@]}")

    if [[ "$agent" == *"Back"* ]]; then
        agent_teams_menu
        return
    fi

    # Get task for agent
    local task
    task=$(gum input \
        --placeholder "Task for $agent..." \
        --prompt "$agent> " \
        --prompt.foreground 51 \
        --width 80)

    if [[ -n "$task" ]]; then
        run_agent "$team" "$agent" "$task"
    fi

    agent_teams_menu
}

# Run a specific agent (uses Claude as sub-agent)
run_agent() {
    local team="$1"
    local agent="$2"
    local task="$3"

    local system_prompt="You are the $agent specialist from the $team team in HIVEMIND. Respond as an expert in your domain. Be concise and technical."

    gum spin --spinner dot --title "Agent $agent processing..." -- sleep 0.5

    echo ""
    gum style --border rounded --border-foreground 51 --padding "1" "$(echo -e "${CYN}[$team] $agent${RST}")"
    echo ""

    # Run with Claude (sub-agent engine)
    echo "$task" | claude --print --system-prompt "$system_prompt" 2>&1 | gum pager
}

# Orchestrate multiple agents
orchestrate_menu() {
    show_banner

    local task
    task=$(gum input \
        --placeholder "Describe the complex task..." \
        --prompt "TASK> " \
        --prompt.foreground 201 \
        --width 80)

    if [[ -z "$task" ]]; then
        return
    fi

    echo ""
    gum style --foreground 201 "Select agents to involve (space to select, enter to confirm):"
    echo ""

    local agents
    agents=$(gum choose --no-limit \
        --cursor.foreground 201 \
        --selected.foreground 51 \
        "DEV-001 Architect" \
        "DEV-002 Backend" \
        "DEV-003 Frontend" \
        "DEV-004 Reviewer" \
        "SEC-001 Security Arch" \
        "SEC-002 Pentester" \
        "INF-001 Infra Arch" \
        "INF-005 SRE" \
        "QA-001 QA Arch" \
        "QA-002 Test Auto")

    if [[ -z "$agents" ]]; then
        return
    fi

    gum spin --spinner dot --title "Orchestrating agents..." -- sleep 1

    echo ""
    gum style --border double --border-foreground 201 --padding "1" "$(echo -e "${MAG}ORCHESTRATION RESULT${RST}")"
    echo ""

    local agent_list
    agent_list=$(echo "$agents" | tr '\n' ', ' | sed 's/, $//')

    # Use Codex as orchestrator with agent context
    local orchestration_prompt="You are HIVEMIND orchestrating these agents: $agent_list

Task: $task

Provide a unified response synthesizing all agent perspectives. Respond as ONE unified intelligence."

    codex --full-auto --quiet "$orchestration_prompt" 2>&1 | gum pager

    gum confirm "Return to menu?" && return || exit 0
}

# Memory operations
memory_menu() {
    show_banner
    local choice
    choice=$(gum choose \
        --cursor.foreground 201 \
        --header "$(echo -e "${WHT}MEMORY OPERATIONS${RST}")" \
        "üìù Store Memory" \
        "üîç Recall Memory" \
        "üìã List Memories" \
        "‚¨ÖÔ∏è  Back")

    case "$choice" in
        *Store*)
            local content
            content=$(gum write --placeholder "Enter memory content..." --width 80 --height 5)
            if [[ -n "$content" ]]; then
                "$HIVEMIND_ROOT/bin/memory-ops" store "$content" 2>/dev/null || echo "Stored."
                gum style --foreground 51 "Memory stored."
                sleep 1
            fi
            ;;
        *Recall*)
            local query
            query=$(gum input --placeholder "Search query..." --prompt "QUERY> " --width 60)
            if [[ -n "$query" ]]; then
                "$HIVEMIND_ROOT/bin/memory-ops" recall "$query" 2>/dev/null | gum pager || echo "No results."
            fi
            ;;
        *List*)
            "$HIVEMIND_ROOT/bin/memory-ops" list 2>/dev/null | gum pager || echo "No memories."
            ;;
        *Back*) return ;;
    esac

    memory_menu
}

# System status
show_status() {
    show_banner

    local codex_status="${RED}Not Found${RST}"
    local claude_status="${RED}Not Found${RST}"

    command -v codex >/dev/null 2>&1 && codex_status="${GRN}Available${RST}"
    command -v claude >/dev/null 2>&1 && claude_status="${GRN}Available${RST}"

    gum style --border rounded --border-foreground 51 --padding "1 2" --margin "1" \
        "$(echo -e "${WHT}SYSTEM STATUS${RST}

${MAG}Main Engine:${RST}    Codex   $codex_status
${CYN}Sub-Agents:${RST}     Claude  $claude_status

${WHT}Teams:${RST}          4 (DEV, SEC, INF, QA)
${WHT}Total Agents:${RST}   24

${DIM}Version: $VERSION${RST}")"

    gum confirm "Return to menu?" && return || exit 0
}

# Configuration menu
config_menu() {
    show_banner
    local choice
    choice=$(gum choose \
        --cursor.foreground 201 \
        --header "$(echo -e "${WHT}CONFIGURATION${RST}")" \
        "üîÑ Swap Main/Sub Engines" \
        "üîë Check API Keys" \
        "üìÅ Show Paths" \
        "‚¨ÖÔ∏è  Back")

    case "$choice" in
        *Swap*)
            local tmp="$MAIN_ENGINE"
            MAIN_ENGINE="$SUB_ENGINE"
            SUB_ENGINE="$tmp"
            gum style --foreground 51 "Swapped: Main=$MAIN_ENGINE, Sub=$SUB_ENGINE"
            sleep 1
            ;;
        *API*)
            echo ""
            [[ -n "${ANTHROPIC_API_KEY:-}" ]] && echo -e "${GRN}‚úì${RST} ANTHROPIC_API_KEY set" || echo -e "${RED}‚úó${RST} ANTHROPIC_API_KEY not set"
            [[ -n "${OPENAI_API_KEY:-}" ]] && echo -e "${GRN}‚úì${RST} OPENAI_API_KEY set" || echo -e "${RED}‚úó${RST} OPENAI_API_KEY not set"
            echo ""
            gum confirm "OK" || true
            ;;
        *Paths*)
            gum style --border rounded --padding "1" \
                "$(echo -e "HIVEMIND_ROOT: $HIVEMIND_ROOT
Memory: $HIVEMIND_ROOT/memory
Workspace: $HIVEMIND_ROOT/workspace")"
            gum confirm "OK" || true
            ;;
        *Back*) return ;;
    esac

    config_menu
}

# Main loop
main() {
    check_deps

    while true; do
        show_banner
        main_menu
    done
}

main "$@"
