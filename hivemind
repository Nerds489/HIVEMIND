#!/bin/bash
#
# ██╗  ██╗██╗██╗   ██╗███████╗███╗   ███╗██╗███╗   ██╗██████╗ 
# ██║  ██║██║██║   ██║██╔════╝████╗ ████║██║████╗  ██║██╔══██╗
# ███████║██║██║   ██║█████╗  ██╔████╔██║██║██╔██╗ ██║██║  ██║
# ██╔══██║██║╚██╗ ██╔╝██╔══╝  ██║╚██╔╝██║██║██║╚██╗██║██║  ██║
# ██║  ██║██║ ╚████╔╝ ███████╗██║ ╚═╝ ██║██║██║ ╚████║██████╔╝
# ╚═╝  ╚═╝╚═╝  ╚═══╝  ╚══════╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝╚═════╝ 
#
# Neural Multi-Agent Orchestration System
# Engine-Agnostic Architecture
#
# Usage:
#   hivemind                           Interactive mode
#   hivemind "task"                    Direct task
#   hivemind --engine codex "task"     Use specific engine for HIVEMIND
#   hivemind --agents claude "task"    Use specific engine for agents
#   hivemind --preset full-codex       Use preset configuration
#   hivemind --config                  Show current configuration
#   hivemind --set-hivemind codex      Set HIVEMIND engine permanently
#   hivemind --set-agents claude       Set agent engine permanently

set -euo pipefail

HIVEMIND_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export HIVEMIND_ROOT

source "$HIVEMIND_ROOT/engines/engine.sh"
source "$HIVEMIND_ROOT/core/router.sh"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

HIVEMIND_ENGINE="${HIVEMIND_ENGINE:-}"
AGENT_ENGINE="${AGENT_ENGINE:-}"
HIVEMIND_MODEL="${HIVEMIND_MODEL:-claude-sonnet-4-20250514}"
AUTO_ORCHESTRATE="${HIVEMIND_AUTO_ORCHESTRATE:-auto}"  # auto|on|off

load_defaults() {
    if [[ -z "$HIVEMIND_ENGINE" ]]; then
        HIVEMIND_ENGINE=$(load_engine_config "hivemind")
    fi
    if [[ -z "$AGENT_ENGINE" ]]; then
        AGENT_ENGINE=$(load_engine_config "agents")
    fi
}

show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ██╗  ██╗██╗██╗   ██╗███████╗███╗   ███╗██╗███╗   ██╗██████╗ 
    ██║  ██║██║██║   ██║██╔════╝████╗ ████║██║████╗  ██║██╔══██╗
    ███████║██║██║   ██║█████╗  ██╔████╔██║██║██╔██╗ ██║██║  ██║
    ██╔══██║██║╚██╗ ██╔╝██╔══╝  ██║╚██╔╝██║██║██║╚██╗██║██║  ██║
    ██║  ██║██║ ╚████╔╝ ███████╗██║ ╚═╝ ██║██║██║ ╚████║██████╔╝
    ╚═╝  ╚═╝╚═╝  ╚═══╝  ╚══════╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝╚═════╝ 
EOF
    echo -e "${NC}"
    echo -e "${PURPLE}         Neural Multi-Agent Orchestration System${NC}"
    echo -e "${BLUE}            24 Agents • 4 Teams • Any Engine${NC}"
    echo ""
}

show_config() {
    echo -e "${CYAN}═══════════════════════════════════════════${NC}"
    echo -e "${CYAN}         HIVEMIND CONFIGURATION            ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Engines:${NC}"
    echo -e "  HIVEMIND runs on:  ${GREEN}$HIVEMIND_ENGINE${NC}"
    echo -e "  Agents run on:     ${GREEN}$AGENT_ENGINE${NC}"
    echo -e "  Model:             ${BLUE}$HIVEMIND_MODEL${NC}"
    echo ""
    echo -e "${YELLOW}Available Presets:${NC}"
    echo -e "  ${BOLD}recommended${NC}   - codex + claude (default)"
    echo -e "  ${BOLD}full-codex${NC}    - codex + codex"
    echo -e "  ${BOLD}full-claude${NC}   - claude + claude"
    echo -e "  ${BOLD}inverse${NC}       - claude + codex"
    echo ""
    echo -e "${YELLOW}Switch with:${NC}"
    echo -e "  hivemind --preset full-codex"
    echo -e "  hivemind --set-hivemind codex --set-agents claude-code"
}

apply_preset() {
    local preset="$1"

    case "$preset" in
        recommended)
            HIVEMIND_ENGINE="codex"
            AGENT_ENGINE="claude"
            ;;
        full-codex)
            HIVEMIND_ENGINE="codex"
            AGENT_ENGINE="codex"
            ;;
        full-claude)
            HIVEMIND_ENGINE="claude"
            AGENT_ENGINE="claude"
            ;;
        inverse)
            HIVEMIND_ENGINE="claude"
            AGENT_ENGINE="codex"
            ;;
        *)
            echo -e "${RED}Unknown preset: $preset${NC}"
            echo "Available: recommended, full-codex, full-claude, inverse"
            exit 1
            ;;
    esac

    echo -e "${GREEN}Applied preset: $preset${NC}"
    echo -e "  HIVEMIND: $HIVEMIND_ENGINE"
    echo -e "  Agents:   $AGENT_ENGINE"
}

save_config() {
    local key="$1"
    local value="$2"

    if command -v yq &> /dev/null; then
        yq -i ".active.$key = \"$value\"" "$HIVEMIND_ROOT/config/engines.yaml"
    else
        sed -i "s/^  $key:.*$/  $key: $value/" "$HIVEMIND_ROOT/config/engines.yaml"
    fi

    echo -e "${GREEN}Saved: $key = $value${NC}"
}

init_session() {
    export HIVEMIND_SESSION="$(date +%Y%m%d_%H%M%S)_$$"
    mkdir -p "$HIVEMIND_ROOT/memory/sessions/$HIVEMIND_SESSION"
    mkdir -p "$HIVEMIND_ROOT/workspace"
    mkdir -p "$HIVEMIND_ROOT/logs"

    mkdir -p "$HIVEMIND_ROOT/memory/short-term"
    [[ -f "$HIVEMIND_ROOT/memory/short-term/context.json" ]] || echo '{}' > "$HIVEMIND_ROOT/memory/short-term/context.json"
    [[ -f "$HIVEMIND_ROOT/memory/short-term/working.json" ]] || echo '{}' > "$HIVEMIND_ROOT/memory/short-term/working.json"
    [[ -f "$HIVEMIND_ROOT/memory/short-term/project-context.json" ]] || echo '{}' > "$HIVEMIND_ROOT/memory/short-term/project-context.json"
    [[ -f "$HIVEMIND_ROOT/memory/short-term/decisions.json" ]] || echo '{}' > "$HIVEMIND_ROOT/memory/short-term/decisions.json"
}

maybe_store_trigger() {
    local task="$1"
    local mem="$HIVEMIND_ROOT/bin/memory-ops"
    [[ -x "$mem" ]] || return 0

    shopt -s nocasematch
    if [[ "$task" =~ ^remember[[:space:]]+that[[:space:]]+(.+) ]]; then
        "$mem" store fact "${BASH_REMATCH[1]}" trigger remember || true
    elif [[ "$task" =~ ^we[[:space:]]+decided[[:space:]]+(.+) ]]; then
        "$mem" store decision "${BASH_REMATCH[1]}" trigger decision || true
    elif [[ "$task" =~ ^i[[:space:]]+prefer[[:space:]]+(.+) ]]; then
        "$mem" store preference "${BASH_REMATCH[1]}" trigger preference || true
    elif [[ "$task" =~ ^always[[:space:]]+(.+) ]]; then
        "$mem" store rule "${BASH_REMATCH[1]}" trigger rule || true
    elif [[ "$task" =~ ^never[[:space:]]+(.+) ]]; then
        "$mem" store rule "${BASH_REMATCH[1]}" trigger rule || true
    fi
    shopt -u nocasematch
}

build_memory_context() {
    local task="$1"
    local mem="$HIVEMIND_ROOT/bin/memory-ops"
    [[ -x "$mem" ]] || return 0

    local prefs="$HIVEMIND_ROOT/memory/long-term/preferences.json"
    local proj="$HIVEMIND_ROOT/memory/long-term/project.json"
    local user="$HIVEMIND_ROOT/memory/long-term/user-profile.json"

    echo "## MEMORY (AUTO-LOADED)"
    [[ -f "$prefs" ]] && echo "- preferences: $prefs"
    [[ -f "$proj" ]] && echo "- project: $proj"
    [[ -f "$user" ]] && echo "- user-profile: $user"
    echo ""
    echo "## RELEVANT MEMORIES (STRING MATCH)"
    "$mem" recall "$task" | head -n 40 || true
    echo ""
}

build_hivemind_prompt() {
    cat << EOF
$(cat "$HIVEMIND_ROOT/IDENTITY.md")

## ENGINE CONFIGURATION

You are running on: $HIVEMIND_ENGINE
Sub-agents run on: $AGENT_ENGINE

To spawn a sub-agent, use:
\$HIVEMIND_ROOT/bin/spawn-agent <agent-type> "<task>"

The spawn-agent script will use the configured agent engine ($AGENT_ENGINE).

## AGENT TYPES AVAILABLE

Development: architect, backend, frontend, reviewer, writer, devops
Security: security-architect, pentester, malware, wireless, compliance, incident
Infrastructure: infra-architect, sysadmin, network, dba, sre, automation
QA: qa-architect, test-auto, performance, security-test, manual-qa, test-data

## WORKSPACE

Agent outputs go to: \$HIVEMIND_ROOT/workspace/<agent>/<task-id>/
Read results from: workspace/<agent>/<task-id>/result.md

## SESSION

Current session: $HIVEMIND_SESSION
Session memory: \$HIVEMIND_ROOT/memory/sessions/$HIVEMIND_SESSION/

$(build_memory_context "${HIVEMIND_LAST_TASK:-}")
EOF
}

run_hivemind() {
    local task="$1"
    local prompt

    export HIVEMIND_LAST_TASK="$task"
    maybe_store_trigger "$task"
    prompt="$(build_hivemind_prompt)"

    export AGENT_ENGINE

    run_engine "$HIVEMIND_ENGINE" "$prompt" "$task" "interactive"
}

run_auto_orchestrate() {
    local task="$1"
    local orchestrate="$HIVEMIND_ROOT/bin/orchestrate"

    if [[ ! -x "$orchestrate" ]] || ! command -v jq >/dev/null 2>&1; then
        run_hivemind "$task"
        return 0
    fi

    mapfile -t agents < <(choose_agents_for_task "$task" || true)
    if [[ "${#agents[@]}" -eq 0 ]]; then
        run_hivemind "$task"
        return 0
    fi

    if [[ "$AUTO_ORCHESTRATE" == "auto" && "${#agents[@]}" -lt 2 ]]; then
        run_hivemind "$task"
        return 0
    fi

    "$orchestrate" "$task" "${agents[@]}"
}

show_status() {
    echo -e "${CYAN}═══════════════════════════════════════════${NC}"
    echo -e "${CYAN}           HIVEMIND SYSTEM STATUS          ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Engines:${NC}"
    echo -e "  HIVEMIND: ${GREEN}$HIVEMIND_ENGINE${NC}"
    echo -e "  Agents:   ${GREEN}$AGENT_ENGINE${NC}"
    echo ""

    local active
    active=$(pgrep -f "hivemind-agent" 2>/dev/null | wc -l)
    echo -e "${YELLOW}Active Agents:${NC} ${GREEN}$active${NC}"

    echo ""
    echo -e "${YELLOW}Teams Ready:${NC}"
    echo -e "  ${GREEN}●${NC} Development    (6 agents)"
    echo -e "  ${GREEN}●${NC} Security       (6 agents)"
    echo -e "  ${GREEN}●${NC} Infrastructure (6 agents)"
    echo -e "  ${GREEN}●${NC} QA             (6 agents)"
}

show_help() {
    echo -e "${BOLD}HIVEMIND${NC} - Neural Multi-Agent Orchestration System"
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo "  hivemind                              Interactive mode"
    echo "  hivemind \"task\"                       Direct task execution"
    echo ""
    echo -e "${YELLOW}ENGINE OPTIONS:${NC}"
    echo "  --engine <engine>                     Set HIVEMIND engine (codex|claude)"
    echo "  --agents <engine>                     Set agent engine (codex|claude)"
    echo "  --preset <name>                       Apply preset configuration"
    echo "  --set-hivemind <engine>               Save HIVEMIND engine to config"
    echo "  --set-agents <engine>                 Save agent engine to config"
    echo ""
    echo -e "${YELLOW}PRESETS:${NC}"
    echo "  recommended                           codex + claude (default)"
    echo "  full-codex                            codex + codex"
    echo "  full-claude                           claude + claude"
    echo "  inverse                               claude + codex"
    echo ""
    echo -e "${YELLOW}OTHER OPTIONS:${NC}"
    echo "  --config                              Show current configuration"
    echo "  --status                              Show system status"
    echo "  --auto                                Enable auto-orchestration for direct tasks"
    echo "  --no-auto                             Disable auto-orchestration for direct tasks"
    echo "  --help                                Show this help"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "  hivemind --preset full-claude"
    echo "  hivemind --engine codex --agents codex \"Build an API\""
    echo "  hivemind \"Design a secure authentication system\""
}

interactive_mode() {
    show_banner
    load_defaults
    init_session

    echo -e "${BLUE}Engine: HIVEMIND=${GREEN}$HIVEMIND_ENGINE${BLUE} | Agents=${GREEN}$AGENT_ENGINE${NC}"
    echo ""
    echo -e "${GREEN}HIVEMIND ready. All teams standing by.${NC}"
    echo -e "${BLUE}Type your request, 'config' to see settings, or 'exit' to quit.${NC}"
    echo ""

    while true; do
        echo -ne "${PURPLE}HIVEMIND>${NC} "
        read -r input

        case "$input" in
            exit|quit|q)
                echo -e "${CYAN}HIVEMIND shutting down.${NC}"
                "$HIVEMIND_ROOT/bin/kill-agents" 2>/dev/null || true
                exit 0
                ;;
            config)
                show_config
                ;;
            status)
                show_status
                ;;
            help)
                show_help
                ;;
            "")
                continue
                ;;
            *)
                echo ""
                run_hivemind "$input"
                echo ""
                ;;
        esac
    done
}

TASK=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --engine|-e)
            HIVEMIND_ENGINE="$2"
            shift 2
            ;;
        --agents|-a)
            AGENT_ENGINE="$2"
            shift 2
            ;;
        --preset|-p)
            load_defaults
            apply_preset "$2"
            shift 2
            ;;
        --set-hivemind)
            save_config "hivemind" "$2"
            shift 2
            ;;
        --set-agents)
            save_config "agents" "$2"
            shift 2
            ;;
        --config|-c)
            load_defaults
            show_config
            exit 0
            ;;
        --status|-s)
            load_defaults
            show_status
            exit 0
            ;;
        --auto)
            AUTO_ORCHESTRATE="on"
            shift
            ;;
        --no-auto)
            AUTO_ORCHESTRATE="off"
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            TASK="$TASK $1"
            shift
            ;;
    esac
done

load_defaults

TASK=$(echo "$TASK" | xargs)

if [[ -z "$TASK" ]]; then
    interactive_mode
else
    show_banner
    init_session
    echo -e "${BLUE}Engine: HIVEMIND=${GREEN}$HIVEMIND_ENGINE${BLUE} | Agents=${GREEN}$AGENT_ENGINE${NC}"
    echo ""
    if [[ "$AUTO_ORCHESTRATE" == "off" ]]; then
        run_hivemind "$TASK"
    else
        run_auto_orchestrate "$TASK"
    fi
fi
